<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Accessibility Issue Creator</title>

<link rel="stylesheet" href="css/superfish.css" media="screen">
<style>
#issues .create .wcag-browser {display: none;}
#project .file {display: none;}
</style>

<script src="jquery.min.js"></script>
<script src="hoverIntent.js"></script>
<script src="superfish.min.js"></script>

<script src="debug.js"></script>
<script src="import.js"></script>
<script src="accessible-superfish.js"></script>
<script src="wcag-browser.js"></script>

</head>
<body>
<div id="app">
<h1 class="title">
<span class="name">Accessibility Issue Creator</span>
<span class="separator" style="display:none"> - </span>
<span class="projectName"></span>
</h1>
</div><!-- #app -->

<div id="status" role="region" aria-label="Status" aria-live="assertive">
</div>

<main>
<div id="project" role="region" aria-label="Project">
<label> Project name: <input type="text" class="projectName"></label>
<button class="new" accesskey="n">New</button>
<button class="load" accesskey="l">Load</button>
<button class="save" accesskey="s">Save</button>
<span class="file">
<label>Choose file: <input hidden type="file" class="name"></label>
<a class="download" href="#">Download</a>
<button class="cancel">Cancel</button>
</span>
</div>

<div id="issues" role="region" aria-label="issue">
<div>
<label>Select issue: <select class="selector" size="1"></select></label>
<button class="delete" accesskey="d">Delete</button>
</div>

<hr>

<div class="create" role="region">
<h2>Create Issue</h2>

<div class="field">
<label>Title: <input type="text" data-name="title"></label>
</div><div class="field">
<label>Guideline: <input type="text" data-name="guideline"></label>
<span class="guidelineFull"></span>
<button class="browse" aria-expanded="false">Browse</button>

<div class="wcag-browser">
<h2>WCAG-2.0 Browser</h2>
<label>Verbosity:
<select class="verbosity" size="1">
<option value="0">Principles</option>
<option value="1">Guidelines</option>
<option selected value="2">Criteria</option>
<option value="3">Off</option>
</select></label>

<div class="menu"></div>

<div class="text" aria-live="polite"></div>
</div><!-- #wcag-browser -->

</div><div class="field">
<label>Priority: <input type="range" data-name="priority" min="1" max="5"></label>
</div><div class="field">
<label>Full description <textarea data-name="long-description"></textarea></label>
</div><div class="field">
<label>Code example: <textarea data-name="code-example"></textarea></label>
</div>

<button class="submit">Submit</button>
</div>

<hr>

<div class="display" role="region">
<label>Display as:<select class="type">
<option value="table">Table</option>
<option value="list">List</option>
</select></label>
<h2>Issues</h2>
</div>

</div><!-- #issues -->
</main>

<div id="debug" aria-live="polite">
</div>


<script>
"use strict";
const fieldNames = getFieldNames ($('#issue-create [data-name]'));
const project = {};

initializeWcagBrowser ($("#issues .create .wcag-browser"));
initializeProject (project);
$(project).on ("update", (e, data) => projectUpdated(e.target, data));

/// projects

$("#project")
.on ("click", ".new", function () {
if (project.durty && !confirm ("Continuing will remove unsaved project data! Do you wish to continue?")) return;
initializeProject (project, "clear local storage");
statusMessage ("New Project initialized.");
return false;
}) // new

.on ("click", ".delete", function (e) {
var index = $("#project .selector").val ();
alert(`deleting ${index}`);
project.issues.splice (index, 1);
update (project);
return true;
}) // .delete

.on ("click", ".load", function (e) {
if (project.durty && !confirm ("Continuing will remove unsaved project data! Do you wish to continue?")) return;
loadProject (project);
return false;
}) // load

.on ("click", ".save", function (e) {
if (project.name) {
saveProject (project);
} else {
statusMessage ("Need a project name.");
$("#project .projectName").focus ();
} // if
return false;
}) // save

.on ("change", ".projectName", function (e) {
project.name = $(e.target).val ();
update (project, {status: false});
return true;
}) // change projectName

.on ("change", ".file .name", function (e) {
var fileSelector = e.target;
var file = fileSelector.files[0];
var reader = null;

debug (`event ${e.type}`);

if (! file) {
statusMessage ("cannot select file.");
return false;
} // if

debug(`file: ${file.size} ${file.name}`);

reader = new FileReader ();
reader.readAsText (file);

$(reader).on ("load", function () {
var newProject = reader.result;

try {
newProject = JSON.parse (reader.result);
Object.assign (project, newProject);
project.durty = false;
$("#issues .selector").focus ();
update (project, {message: "loaded"});

} catch (e) {
statusMessage (`${e} -- cannot parse file.`);
} // try
}); // file.load
return true;
}) // change .fileName

.on ("click", ".file .cancel", function (e) {
$("#project .save").focus ();
$("#project .file").hide ();
}) // cancel

.on ("click", ".download", function (e) {
$("#project .file").hide ();
return true;
});

// helpers

function initializeProject (project, clearLocalStorage) {
Object.assign (project,{
name: "",
issues: [],
durty: false
});


if (localStorage) {
if (clearLocalStorage) {
localStorage.project = null;
} else if (localStorage.project) {
project = JSON.parse(localStorage.project);
} // if

} else {
alert ("Local storage not available, so download often!");
} // if

statusMessage ("Ready.");
return project;
} // initializeProject

function loadProject (project) {
$("#project .file .name").trigger ("click");
} // loadProject

function saveProject (project) {
var url =  createBlob (project);
$("#project .file").show ()
.find (".download").attr ({
"href": url,
"download": project.name + ".json"
}).focus ();
} // saveProject


function update (object, data) {
data = Object.assign ({displayStatus: true, message: ""}, data);
$(object).trigger ("update", data);
} // update

function projectUpdated (project, data) {
var message = (message)?
" " + data.message : "";
if (localStorage) {
localStorage.project = JSON.stringify (project);
} // if

$("#project .projectName").val (project.name);
updateAppTitle (project.name);
generateIssueDisplay (project.issues);

if (data.displayStatus) statusMessage (`${project.issues.length} issues${message}.`);
} // projectUpdated

function updateAppTitle (name) {
if (name) {
$("#app .projectName").text (name);
$("#app .separator").show ();
$("title").text ( $("#app .title").text() );

} else {
$("#app .projectName").text ("");
$("#app .separator").hide ();
$("title").text ( $("#app .name").text() );
} // if

} // updateAppTitle

/// wcag browser

$("#issues .create .wcag-browser").on ("display", function (e, html) {
var $html = $('<div></div>').html (html);
var text = $html.find (".sc-handle").text ();
var level = $html.text().match (/\(Level (A+)\)/);

$("#issues .create [data-name=guideline]").val (`${text} (${level[1]})`);
$("#issues .create .guidelineFull").html (html);
}); // display text in WCAG browser


/// issues

$("#issues")
.on ("loaded", ".wcag-browser", function () {
statusMessage ("Guideline data loaded.");
})

.on ("click", ".create .browse", function (e) {
var $browser = $("#issues .create .wcag-browser");
var $browse = $(e.target);

if ($browse.attr("aria-expanded") === "true") {
$browser.hide ();
$browse.attr ("aria-expanded", "false");
} else if ($browse.attr ("aria-expanded") === "false") {
$browser.show ()
.find (".verbosity").focus ();
$browse.attr ("aria-expanded", "true");
} // if

return true;
}) // browse

.on ("click", ".submit", function (e) {
project.issues.push (getIssueData ($("#issues .create [data-name]")));
project.durty = true;
update (project);
return false;
}) // create

.on ("change", ".display .type", function () {
generateIssueDisplay (project.issues);
statusMessage ("Display reset.");
return true;
})

.on ("change", ".selector", function () {
var index = Number($(this).val ());
var issue;

if (index >= 0) {
issue = project.issues[index];
setIssueData ($("#issues .create [data-name]"), issue);
} // if
return true;
});

// helpers

function generateIssueDisplay (issues) {
$("#issues .display table, #issues .display ol").remove ();
createIssueDisplay (issues, $("#issues .display .type").val())
.appendTo ("#issues .display");
generateIssueSelector (issues);
} // generateIssueDisplay

function createIssueDisplay (issues, type) {
if (type === "table") {
return createIssueTable (issues);
} else if (type === "list") {
return createIssueList (issues);
} else {
alert (`createIssueDisplay: invalid type -- ${type}`);
return null;
} // if
} // createIssueDisplay
function createTableHeaders (fieldNames) {
var $headers = $('<tr><th>Number</th></tr>');

fieldNames.forEach ((name) => $headers.append (`<th>${name}</th>`));
return $headers;
} // createTableHeaders

function createIssueTable (issues) {
var $issues = $('<table><thead></thead><tbody></tbody></table>');
$("thead", $issues).append (createTableHeaders (fieldNames));

issues.forEach (function (issue, index) {
var $issue = $(`<tr class="issue"><td>${index+1}</td></tr>`);

issue.forEach (function (field) {
var $field = $('<td></td>');
$field.data ("name", field.name);
$field.text (field.value);
$issue.append ($field);
}); // forEach issue

$("tbody", $issues).append ($issue);
}); // forEach issues

return $issues;
} // createIssueTable

function createIssueList (issues) {
var $issues = $('<ol></ol>');

issues.forEach (function (issue, index) {
var $issue = $(`<li class="issue"></li>`);

issue.forEach (function (field) {
var $field = $('<div></div>');
$field.html (`
<span class="name">${field.name}</span>
<span class="value">${field.value}</span>
`);
$issue.append ($field);
}); // forEach issue

$issues.append ($issue);
}); // forEach issues

return $issues;
} // createIssueList

function getIssueData ($issue) {
var issueData = [];

issueData = $issue.get().map (function (element) {
var name = $(element).data ("name");
return {name: name.trim(), value: $(element).val().trim()};
}); // map

return issueData;
} // getIssueData

function setIssueData ($issue, data) {
$issue.each (function (i, element) {
$(this).val (data[i].value);
}); // each
} // setIssueData

function generateIssueSelector (issues) {
$("#issues .selector").empty()
.append (createIssueSelector (issues));
} // generateIssueSelector

function createIssueSelector (issues) {
var $options = $('<option value="-1">[none]</option>');
getIssueField ("title", issues)
.forEach ((text, index) => $options = $options.add (`<option value=${index}>${text}</option>`))
return $options;
} // createIssueSelector

function getIssueField (name, issues) {
var names = issues.map (function (issue) {
var value = issue.find (function (x) {
//debug ("x: ", x);
return x.name === name;
}); // find

//debug ("value: ", name, value);
return (value)? value.value : "";
});

//debug ("fields: ", names);
return names;
} // getIssueField

function createBlob (object) {
var data = new Blob ([JSON.stringify(object)], {type: "application/json"});
return URL.createObjectURL(data);
} // createBlob

function getFieldNames ($fields) {
return $fields.map ((i, element) => $(element).data ("name").trim()).get();
} // getFieldNames

function statusMessage (message) {
$("#status").html("").text(message);
} // statusMessage


</script>

</body>
</html>
